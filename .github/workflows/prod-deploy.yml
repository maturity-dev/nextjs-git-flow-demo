name: Deploy Prod

on:
  # 1. 정식 버전 태그 푸시 시 자동 실행 (예: v1.0.0)
  push:
    tags:
      - "v*"           # v1.0.0, v2.1.3 등 매칭
      - "!v*-rc.*"     # RC 태그(v...-rc...)는 제외 (안전 장치)
  
  # 2. 수동 실행 (롤백/재배포 용도)
  # GitHub Actions 탭에서 'Run workflow' 버튼으로 실행 가능
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to deploy (e.g. v1.3.9)"
        required: true

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      # inputs.tag가 있으면(롤백 시) 해당 태그 시점으로, 없으면 현재 푸시된 태그로 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      # 2. Node.js 환경 설정
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3. 의존성 설치
      - name: Install Dependencies
        run: npm ci

      # 4. 프로젝트 빌드
      - name: Build
        run: npm run build

      # 5. 운영(Prod) 환경 배포 시뮬레이션
      - name: Deploy to Prod (Simulation)
        run: |
          echo "Deploying to PRODUCTION Environment..."
          echo "Target Ref: ${{ inputs.tag || github.ref }}"
          echo "Commit: ${{ github.sha }}"
          # 실제 운영 배포 명령어는 여기에 추가
          echo "PRODUCTION DEPLOYMENT SUCCESS"
